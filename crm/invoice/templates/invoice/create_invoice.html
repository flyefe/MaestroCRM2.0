{% extends 'core/base.html' %}

{% block content %}
<div class="container mx-auto p-6">
    <h1 class="text-2xl font-bold">New Invoice</h1>

    <!-- Invoice Header -->
    <div class="flex justify-between items-center border-b pb-4 mb-4">
        <div>
            <img src="{{ company_logo_url }}" alt="Company Logo" class="h-12">

            <div>
                <p class="text-lg font-semibold">{{ company_name }}</p>
                <p>{{ business_type }}</p>
                <p>{{ contact_email }}</p>
                <p><a href="{{ website_link }}" class="text-blue-600">{{ website_link }}</a></p>
            </div>
        </div>
        <div>
            <label class="block">Assign Invoice To</label>
            <!-- <input type="text" name="assign_to" class="w-full p-2 border rounded"> -->
            <input type="text" id="contact-autocomplete" name="contact" class="w-full p-2 border rounded"
                placeholder="Type name or email..." autocomplete="off">
            
            <ul id="contact_suggestions" class="border rounded bg-white max-h-48 overflow-y-auto hidden"></ul>

        </div>
    </div>



    <!-- Invoice Details -->
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label class="block">Invoice Status</label>
            <select class="w-full p-2 border rounded" name="invoice_status">
                {% for value, label in status_choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block">Invoice Date</label>
            <input type="date" name="invoice_date" class="w-full p-2 border rounded">
        </div>
        <div>
            <label class="block">Reference Number</label>
            <input type="text" name="reference_number" value="{{ reference_number }}" class="w-full p-2 border rounded"
                readonly>
        </div>
        <div>
            <label class="block">Due Date</label>
            <select class="w-full p-2 border rounded" name="unit_measurement">
                <option value="">No Due date</option>
                <option value="">Due on reciept</option>
                <option value="">Due in 10 Dyas</option>
            </select>
        </div>
    </div>

    <!-- Currency and Rate Fields -->
    <div class="grid grid-cols-3 gap-4 mb-4">
        <div>
            <label class="block">Unit of Measurement</label>
            <select id="unit_measurement" class="w-full p-2 border rounded" name="unit_measurement"
                onchange="updateTableHeaders()">
                {% for value, label in unit_measurement_choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block">Quote Currency</label>
            <select id="quote_currency" class="w-full p-2 border rounded" name="quote_currency"
                onchange="updateTableHeaders()">
                {% for value, label in quote_currency_choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block">Naira to USD</label>
            <input type="number" name="rate_naira_usd" class="w-full p-2 border rounded">
        </div>
        <div>
            <label class="block">Yuan to USD</label>
            <input type="number" name="rate_yuan_usd" class="w-full p-2 border rounded">
        </div>
        <div>
            <label class="block">Naira to Yuan</label>
            <input type="number" name="rate_naira_yuan" class="w-full p-2 border rounded">
        </div>
    </div>

    <!-- Invoice Items Table -->
    <table class="w-full mt-6 border-collapse border">
        <thead>
            <tr class="bg-gray-200">
                <th class="border p-2">Title & Description</th>
                <th id="unit_header" class="border p-2">Quantity</th>
                <th class="border p-2">Price</th>
                <th class="border p-2">Currency</th>
                <th id="quote_currency_header" class="border p-2">NGN</th>
                <th class="border p-2">Tax</th>
                <th class="border p-2">Amount</th>
                <th class="border p-2"></th>
            </tr>
        </thead>
        <tbody id="invoice-items">
            <!-- Dynamic Rows Will Be Added Here -->
        </tbody>
    </table>
    <button onclick="addRow()" class="mt-2 bg-blue-500 text-white p-2 rounded">Add Item</button>

    <!-- Invoice Summary -->
    <div class="mt-6 p-4 border rounded">
        <p><strong>Subtotal:</strong> <span id="currency_sign">₦</span> <span id="subtotal">0</span></p>
        <p><strong>Total VAT:</strong> <span id="currency_sign_vat">₦</span> <span id="total_vat">0</span></p>
        <p><strong>Grand Total:</strong> <span id="currency_sign_total">₦</span> <span id="grand_total">0</span></p>
    </div>

    <!-- Actions -->
    <div class="mt-6">
        <button class="bg-green-500 text-white p-2 rounded">Save Invoice</button>
        <button class="bg-gray-500 text-white p-2 rounded">Download PDF</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.addEventListener("input", function (event) {
            if (event.target.matches("input, select")) {
                updateQuoteCurrencyEquivalent();
                updateInvoiceSummary();
            }
        });

        const input = document.getElementById("contact-autocomplete");
        if (input) {
            const suggestionBox = document.createElement("div");
            suggestionBox.style.position = "absolute";
            suggestionBox.style.border = "1px solid #ccc";
            suggestionBox.style.backgroundColor = "white";
            suggestionBox.style.zIndex = "1000";
            suggestionBox.style.width = input.offsetWidth + "px";
            input.parentNode.appendChild(suggestionBox);

            input.addEventListener("input", function () {
                const query = input.value.trim();
                if (query.length < 2) {
                    suggestionBox.innerHTML = "";
                    return;
                }

                fetch(`/autocomplete/contact/?query=${encodeURIComponent(query)}`)
                    .then(response => {
                        return response.json();
                    })
                    .then(data => {
                        suggestionBox.innerHTML = "";
                        if (data.results.length === 0) {
                            suggestionBox.innerHTML = "<div class='p-2 text-gray-500'>No results</div>";
                            return;
                        }
                        data.results.forEach(contact => {
                            const item = document.createElement("div");
                            item.innerHTML = `<strong>${contact.name}</strong> - ${contact.email}`;
                            item.style.padding = "5px";
                            item.style.cursor = "pointer";
                            item.addEventListener("click", function () {
                                input.value = `${contact.name}`;
                                suggestionBox.innerHTML = "";
                            });
                            suggestionBox.appendChild(item);
                        });
                    })
                    .catch(error => console.error("Autocomplete error:", error));
            });

            document.addEventListener("click", function (event) {
                if (!input.contains(event.target)) {
                    suggestionBox.innerHTML = "";
                }
            });
        }
    });

    function addRow(event) {
        if (event) event.preventDefault();
        let table = document.querySelector("#invoice-items");
        let row = document.createElement("tr");
        row.innerHTML = `
        <td>
            <input type="text" name="title" class="w-full p-2 border" placeholder="Title">
            <textarea name="description" class="w-full p-2 border" rows="2" placeholder="Description"></textarea>
        </td>
        <td><input type="number" name="unit" class="w-full p-2 border"></td>
        <td><input type="number" name="price" class="w-full p-2 border"></td>
        <td>
            <select name="currency" class="w-full p-2 border">
                {% for value, label in currency_choices %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </td>
        <td><input type="number" name="quote_currency_equivalent" class="w-full p-2 border" readonly></td>
        <td>
            <select name="tax" class="w-full p-2 border">
                <option value="0">No Tax</option>
                <option value="7.5">VAT (7.5%)</option>
            </select>
        </td>
        <td><input type="number" name="amount" class="w-full p-2 border" readonly></td>
        <td><button onclick="removeRow(this)" class="text-red-500">❌</button></td>
    `;
        table.appendChild(row);
    }

    function removeRow(btn) {
        btn.closest("tr").remove();
        updateInvoiceSummary();
    }

    function updateTableHeaders() {
            let unitText = document.getElementById("unit_measurement").value;
            let quoteCurrency = document.getElementById("quote_currency").value;
            document.getElementById("unit_header").innerText = unitText;
            document.getElementById("quote_currency_header").innerText = quoteCurrency;
            updateQuoteCurrencyEquivalent();
            updateInvoiceSummary();
        }

    function updateQuoteCurrencyEquivalent() {
        let quoteCurrencyElement = document.querySelector("#quote_currency");
        let quoteCurrency = quoteCurrencyElement ? quoteCurrencyElement.value : "USD";

        let rateNairaUSD = parseFloat(document.querySelector("input[name='rate_naira_usd']")?.value) || 1;
        let rateYuanUSD = parseFloat(document.querySelector("input[name='rate_yuan_usd']")?.value) || 1;
        let rateNairaYuan = parseFloat(document.querySelector("input[name='rate_naira_yuan']")?.value) || 1;

        document.querySelectorAll("#invoice-items tr").forEach(row => {
            let priceField = row.querySelector("input[name='price']");
            let currencyField = row.querySelector("select[name='currency']");
            let quoteCurrencyField = row.querySelector("input[name='quote_currency_equivalent']");

            if (priceField && currencyField && quoteCurrencyField) {
                let price = parseFloat(priceField.value) || 0;
                let currency = currencyField.value;
                let convertedPrice = price;

                if (currency !== quoteCurrency) {
                    if (currency === "NGN" && quoteCurrency === "USD") {
                        convertedPrice = price / rateNairaUSD;
                    } else if (currency === "USD" && quoteCurrency === "NGN") {
                        convertedPrice = price * rateNairaUSD;
                    } else if (currency === "Yuan" && quoteCurrency === "USD") {
                        convertedPrice = price / rateYuanUSD;
                    } else if (currency === "USD" && quoteCurrency === "Yuan") {
                        convertedPrice = price * rateYuanUSD;
                    } else if (currency === "NGN" && quoteCurrency === "Yuan") {
                        convertedPrice = price / rateNairaYuan;
                    } else if (currency === "Yuan" && quoteCurrency === "NGN") {
                        convertedPrice = price * rateNairaYuan;
                    }
                }
                quoteCurrencyField.value = convertedPrice.toFixed(2);
            }
        });

        document.getElementById("quote_currency").addEventListener("change", function () {
            let selectedCurrency = this.value;
            document.getElementById("currency_sign").textContent = selectedCurrency;
            document.getElementById("currency_sign_vat").textContent = selectedCurrency;
            document.getElementById("currency_sign_total").textContent = selectedCurrency;
        });

        updateInvoiceSummary();
    }

    function updateInvoiceSummary() {
        let subtotal = 0, totalVAT = 0, grandTotal = 0;
        document.querySelectorAll("#invoice-items tr").forEach(row => {
            let unit = parseFloat(row.querySelector("input[name='unit']")?.value) || 0;
            let price = parseFloat(row.querySelector("input[name='quote_currency_equivalent']")?.value) || 0;
            let taxRate = parseFloat(row.querySelector("select[name='tax']")?.value) || 0;

            let amount = unit * price;
            let taxAmount = (amount * taxRate) / 100;
            let total = amount + taxAmount;

            row.querySelector("input[name='amount']").value = total.toFixed(2);

            subtotal += amount;
            totalVAT += taxAmount;
            grandTotal += total;
        });
        document.getElementById("subtotal").innerText = subtotal.toFixed(2);
        document.getElementById("total_vat").innerText = totalVAT.toFixed(2);
        document.getElementById("grand_total").innerText = grandTotal.toFixed(2);
    }

</script>

{% endblock %}